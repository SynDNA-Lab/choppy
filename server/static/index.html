<!DOCTYPE html> 
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Sequence Homology Annotator</title>
</head>
<body>
    <section class="section">
        <h1 class="title">Choppy</h1>
        <h2 class="subtitle">A tool to chop your sequence into pieces</h2>
    </section>
    <section class="section">
        <div class="fixed-grid">
            <div class="grid">
                <div class="grid-item">
                    <label class="label">
                        Query sequence
                        <span class="icon has-text-info" style="cursor: pointer;" onclick="openModal('queryModal')">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </label>
                    <textarea id="querySequence" class="textarea" placeholder="Insert your sequence here"></textarea>
                    <p id="sequenceError" class="help is-danger" style="display: none;"></p>
                    <div class="file has-name is-fullwidth">
                        <label class="file-label">
                            <input id="queryFileInput" class="file-input" type="file" name="query_file" accept=".gb,.gbk,.genbank,.fa,.fasta"/>
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label"> Choose a file… </span>
                            </span>
                            <span id="queryFileName" class="file-name"> No file selected </span>
                        </label>
                    </div>
                </div>
                <div class="grid-item">
                    <label class="label">
                        Background sequences
                        <span class="icon has-text-info" style="cursor: pointer;" onclick="openModal('backgroundModal')">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </label>
                    <div class="file has-name is-fullwidth">
                        <label class="file-label">
                            <input class="file-input" type="file" name="background_files" accept=".gb,.gbk,.genbank,.fa,.fasta" multiple/>
                            <span class="file-cta">
                                <span class="file-icon">
                                    <i class="fas fa-upload"></i>
                                </span>
                                <span class="file-label"> Choose files… </span>
                            </span>
                            <span id="backgroundFileNames" class="file-name"> No files selected </span>
                        </label>
                    </div>
                    <div class="content">
                        <p class="has-text-weight-semibold">Precalculated backgrounds:</p>
                        <div class="box" style="max-height: 150px; overflow-y: auto;">
                            {% for bg in bgs %}
                            <label class="checkbox">
                                <input type="checkbox" name="data_item" value="{{ bg.id }}">
                                <i>{{ bg.species }}</i> ({{ bg.assembly }}) - K-mer Size: {{ bg.kmer_size }}
                            </label>
                            <br>
                            {% endfor %}
                        </div>
                    </div>
                   <div class="field is-grouped">
                        <p class="control">
                            <button id="processButton" class="button is-primary" type="button">
                                <span class="icon">
                                    <i class="fas fa-play"></i>
                                </span>
                                <span>Run</span>
                            </button>
                        </p>
                        <p class="control">
                            <button class="button is-link disabled" type="button" disabled>
                                <span class="icon">
                                    <i class="fas fa-download"></i>
                                </span>
                                <span>Download Background</span>
                            </button>
                        </p>
                    </div>                    
                </div>
            </div>
        </div>
        <div class="fixed-grid">
            <div class="grid">
                <div class="grid-item">
                    <h5 class="title is-5">
                        Parameters for the homology finder
                        <span class="icon has-text-info" style="cursor: pointer;" onclick="openModal('homologyParamsModal')">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </h5>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">K-mer Size</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="kmer_size" value="20" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Threshold</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="threshold" value="60" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="grid-item">
                    <h5 class="title is-5">
                        Parameters for the fragmentor
                        <span class="icon has-text-info" style="cursor: pointer;" onclick="openModal('fragmentParamsModal')">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </h5>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Min Size (bp)</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="min_size" value="500" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Max Size (bp)</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="max_size" value="3000" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Min Overlap (bp)</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="min_overlap" value="60" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Max Overlap (bp)</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="max_overlap" value="100" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Boundary Motif</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input id="boundaryMotif" class="input" type="text" name="boundary_motif" placeholder="e.g., GC (optional)">
                                </div>
                                <p id="motifError" class="help is-danger" style="display: none;"></p>
                            </div>
                        </div>
                    </div>
                    <div class="field is-horizontal">
                        <div class="field-label is-normal">
                            <label class="label">Min Step (bp)</label>
                        </div>
                        <div class="field-body">
                            <div class="field">
                                <div class="control">
                                    <input class="input" type="number" name="min_step" value="10" min="1">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

<!-- Modals for extra info -->
<div id="queryModal" class="modal">
    <div class="modal-background" onclick="closeModal('queryModal')"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Query Sequence Information</p>
            <button class="delete" aria-label="close" onclick="closeModal('queryModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p>Enter your DNA sequence as plaintext or upload a file in one of the following formats:</p>
                <p><strong>Supported formats:</strong></p>
                <ul>
                    <li>FASTA format</li>
                    <li>GenBank format</li>
                </ul>
                
                <div class="notification">
                    <p class="is-size-6 has-text-weight-semibold mb-2">Important notes:</p>
                    <ul class="is-size-7">
                        <li>Currently only one sequence at a time can be analysed.</li>
                        <li>If you upload a file in the GenBank format, all the existing annotations will be included in the output.</li>
                    </ul>
                </div>
            </div>
        </section>
    </div>
</div>
<div id="backgroundModal" class="modal">
    <div class="modal-background" onclick="closeModal('backgroundModal')"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Background Sequences Information</p>
            <button class="delete" aria-label="close" onclick="closeModal('backgroundModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p>Upload one or more backgroud sequences files in the following formats:</p>
                <p><strong>Supported formats:</strong></p>
                <ul>
                    <li>FASTA format</li>
                    <li>GenBank format</li>
                </ul>
                <p>Motifs from these sequences will be avoided in the overlapping areas of the generated fragments.</p>
            </div>
        </section>
    </div>
</div>
<div id="homologyParamsModal" class="modal">
    <div class="modal-background" onclick="closeModal('homologyParamsModal')"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Homology Parameters</p>
            <button class="delete" aria-label="close" onclick="closeModal('homologyParamsModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p>Choppy makes sure that the overlapping regions of the fragments are not present in the background. 
                    To this end, the overlapping regions are allowed only in the so called non-homologous regions. These
                    parameters control how these regions are defined.
                </p>
                <p><strong>K-mer Size:</strong> The size of the k-mers used to identify non-homologous regions. 
                    A region can be called non-homologous only if it doesn't share any kmers with the backgroud sequences.</p>
                <p><strong>Threshold:</strong> The minimum length of a region that will be annotated as a non-homologous.
                Use it to avoid cluttering the annotation with the regions that are too short to contain a valid overlap.</p>
            </div>
        </section>
    </div>
</div>
<div id="fragmentParamsModal" class="modal">
    <div class="modal-background" onclick="closeModal('fragmentParamsModal')"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Fragment Parameters</p>
            <button class="delete" aria-label="close" onclick="closeModal('fragmentParamsModal')"></button>
        </header>
        <section class="modal-card-body">
            <div class="content">
                <p>These parameters control how your sequence will be fragmented for TAR cloning.</p>
                
                <p><strong>Min Size &amp; Max Size:</strong> The minimum and maximum length of each fragment in base pairs. 
                Fragments will be generated within this size range.</p>
                
                <p><strong>Min Overlap &amp; Max Overlap:</strong> The minimum and maximum length of overlapping regions 
                between adjacent fragments in base pairs. These overlaps enable homologous recombination during assembly.</p>
                
                <p><strong>Boundary Motif:</strong> (Optional) A DNA sequence motif that must occur at fragment boundaries 
                (both start and end). For example, "GC" ensures fragments start and end with this motif. Leave empty to allow 
                any boundary.</p>
                
                <p><strong>Min Step:</strong> Step size for scanning overlap positions in base pairs. Smaller values provide 
                more precise fragmentation but take longer to compute. Default is 10 bp.</p>
                
                <div class="notification is-info is-light">
                    <p class="is-size-7">
                        <strong>Note:</strong> Overlaps will only be placed in non-homologous regions identified by the 
                        homology finder parameters above.
                    </p>
                </div>
            </div>
        </section>
    </div>
</div>


<script>

function validateSequence(sequence) {
    const validPattern = /^[ATCGatcg\s\t\n\r]*$/;
    return validPattern.test(sequence);
}

function validateMotif(motif) {
    // Only ATCG allowed, no spaces or other characters
    const validPattern = /^[ATCGatcg]*$/;
    return validPattern.test(motif);
}

const querySequenceTextarea = document.getElementById('querySequence');
const sequenceError = document.getElementById('sequenceError');
const queryFileInput = document.getElementById('queryFileInput');
const queryFileName = document.getElementById('queryFileName');
const boundaryMotifInput = document.getElementById('boundaryMotif');
const motifError = document.getElementById('motifError');

// Handle background files display
const backgroundFilesInput = document.querySelector('input[name="background_files"]');
const backgroundFileNames = document.getElementById('backgroundFileNames');

if (backgroundFilesInput) {
    backgroundFilesInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const fileNames = Array.from(this.files).map(f => f.name).join(', ');
            backgroundFileNames.textContent = `${this.files.length} file(s): ${fileNames}`;
        } else {
            backgroundFileNames.textContent = 'No files selected';
        }
    });
}

queryFileInput.addEventListener('change', function() {
    if (this.files.length > 0) {
        const file = this.files[0];
        queryFileName.textContent = file.name;
        querySequenceTextarea.disabled = true;
        querySequenceTextarea.placeholder = 'Text input disabled (file selected)';
    } else {
        queryFileName.textContent = 'No file selected';
        querySequenceTextarea.disabled = false;
        querySequenceTextarea.placeholder = 'Insert your sequence here';
    }
});


querySequenceTextarea.addEventListener('input', function() {
    const value = this.value;
    
    // Validation
    if (value.length === 0) {
        this.classList.remove('is-danger');
        sequenceError.style.display = 'none';
    } else if (!validateSequence(value)) {
        this.classList.add('is-danger');
        sequenceError.textContent = 'Invalid characters detected. Only A, T, C, G, spaces, tabs, and line breaks are allowed.';
        sequenceError.style.display = 'block';
    } else {
        this.classList.remove('is-danger');
        sequenceError.style.display = 'none';
    }
});

// Boundary motif validation
boundaryMotifInput.addEventListener('input', function() {
    const value = this.value;
    
    if (value.length === 0) {
        // Empty is okay (optional field)
        this.classList.remove('is-danger');
        motifError.style.display = 'none';
    } else if (!validateMotif(value)) {
        // Invalid characters found
        this.classList.add('is-danger');
        motifError.textContent = 'Invalid characters detected. Only A, T, C, G are allowed.';
        motifError.style.display = 'block';
    } else {
        // Valid motif
        this.classList.remove('is-danger');
        motifError.style.display = 'none';
    }
});

// Modal functions
function openModal(modalId) {
    document.getElementById(modalId).classList.add('is-active');
}

function closeModal(modalId) {
    document.getElementById(modalId).classList.remove('is-active');
}

// Close modal when pressing ESC key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        document.querySelectorAll('.modal.is-active').forEach(modal => {
            modal.classList.remove('is-active');
        });
    }
});

document.getElementById('processButton').addEventListener('click', async () => {
    const button = document.getElementById('processButton');
    
    try {
        const queryText = querySequenceTextarea.value.trim();
        const queryFile = queryFileInput.files[0];
        const backgroundFilesInput = document.querySelector('input[name="background_files"]');
        const backgroundFiles = backgroundFilesInput ? backgroundFilesInput.files : [];
        
        if (!queryText && !queryFile) {
            alert('Please provide a query sequence (either as text or file upload)');
            return;
        }
        if (sequenceError.style.display !== 'none' || motifError.style.display !== 'none') {
            alert('Please fix validation errors before submitting');
            return;
        }
        button.disabled = true;
        button.innerHTML = '<span class="icon"><i class="fas fa-spinner fa-spin"></i></span><span>Processing...</span>';
        
        const formData = new FormData();
        
        if (queryFile) {
            formData.append('query_file', queryFile);
        } else {
            const blob = new Blob([">User_Sequence\n" + queryText], { type: 'text/plain' });
            formData.append('query_file', blob, 'query_sequence.fasta');
        }
        
        for (let i = 0; i < backgroundFiles.length; i++) {
            formData.append('background_files', backgroundFiles[i]);
        }
        
        formData.append('kmer_size', document.querySelector('input[name="kmer_size"]').value);
        formData.append('threshold', document.querySelector('input[name="threshold"]').value);
        formData.append('min_size', document.querySelector('input[name="min_size"]').value);
        formData.append('max_size', document.querySelector('input[name="max_size"]').value);
        formData.append('min_overlap', document.querySelector('input[name="min_overlap"]').value);
        formData.append('max_overlap', document.querySelector('input[name="max_overlap"]').value);
        formData.append('boundary_motif', boundaryMotifInput.value);
        formData.append('min_step', document.querySelector('input[name="min_step"]').value);
        
        const response = await fetch('./process-and-fragment', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        
        if (result.annotated_file) {
            downloadBase64File(result.annotated_file, result.annotated_filename || 'annotated.gb');
        }
        
        if (result.fragments_file) {
            downloadBase64File(result.fragments_file, result.fragments_filename || 'fragments.fasta');
        }
        
        alert('Processing complete! Files downloaded.');
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error processing sequence: ' + error.message);
    } finally {
        button.disabled = false;
        button.innerHTML = '<span class="icon"><i class="fas fa-play"></i></span><span>Run</span>';
    }
});

// Helper function to download base64-encoded file
function downloadBase64File(base64Data, filename) {
    const binaryString = atob(base64Data);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    const blob = new Blob([bytes], { type: 'application/octet-stream' });
    
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
}
</script>    
</body>
</html>